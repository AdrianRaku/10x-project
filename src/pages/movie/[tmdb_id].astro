---
import Layout from "../../layouts/Layout.astro";
import { Button } from "../../components/ui/button";
import { MovieRating } from "../../components/MovieRating";
import { ArrowLeft } from "lucide-react";

export const prerender = false;

const { tmdb_id } = Astro.params;

if (!tmdb_id || isNaN(Number(tmdb_id))) {
  return Astro.redirect("/");
}

// Get TMDb API key from environment
const tmdbApiKey = import.meta.env.TMDB_API_KEY;

if (!tmdbApiKey) {
  throw new Error("TMDB_API_KEY environment variable is not set");
}

// Fetch movie details from TMDb API
const movieResponse = await fetch(
  `https://api.themoviedb.org/3/movie/${tmdb_id}?api_key=${tmdbApiKey}&language=pl-PL`
);

if (!movieResponse.ok) {
  return Astro.redirect("/");
}

const movie = await movieResponse.json();

const TMDB_IMAGE_BASE_URL = "https://image.tmdb.org/t/p/w500";
const TMDB_BACKDROP_BASE_URL = "https://image.tmdb.org/t/p/original";
const posterUrl = movie.poster_path ? `${TMDB_IMAGE_BASE_URL}${movie.poster_path}` : null;
const backdropUrl = movie.backdrop_path ? `${TMDB_BACKDROP_BASE_URL}${movie.backdrop_path}` : null;
const releaseYear = movie.release_date ? new Date(movie.release_date).getFullYear() : null;
---

<Layout title={`${movie.title} - MyFilms`}>
  <div class="h-screen bg-background overflow-hidden flex items-center justify-center px-8 py-8">
    <!-- Content -->
    <div class="flex gap-12 items-start max-w-5xl mx-auto">
        <!-- Poster -->
        <div class="w-[300px] h-[450px] flex-shrink-0 flex items-center justify-center border-2 border-border rounded-lg bg-card p-4">
          {posterUrl ? (
            <img
              src={posterUrl}
              alt={`Plakat filmu ${movie.title}`}
              class="max-w-full max-h-full w-auto h-auto object-contain rounded-md shadow-md"
            />
          ) : (
            <div class="flex w-full h-full items-center justify-center rounded-md bg-muted">
              <span class="text-sm text-muted-foreground">Brak plakatu</span>
            </div>
          )}
        </div>

        <!-- Details -->
        <div class="grid grid-rows-[1fr_auto] flex-1 max-w-2xl border-2 border-border rounded-lg bg-card p-8 h-[450px] gap-4">
          <!-- Scrollable content area -->
          <div class="space-y-6 overflow-y-auto min-h-0">
            <div class="space-y-3">
              <h1 class="text-4xl font-bold tracking-tight">
                {movie.title}
              </h1>
              {movie.tagline && (
                <p class="text-lg italic text-muted-foreground">
                  {movie.tagline}
                </p>
              )}
              <div class="flex flex-wrap gap-4 text-base text-muted-foreground">
                {releaseYear && <span>{releaseYear}</span>}
                {movie.runtime && <span>{movie.runtime} min</span>}
                {movie.vote_average && (
                  <span class="flex items-center gap-1">
                    ⭐ {movie.vote_average.toFixed(1)}/10
                  </span>
                )}
              </div>
            </div>

            {movie.genres && movie.genres.length > 0 && (
              <div class="flex flex-wrap gap-2">
                {movie.genres.map((genre: any) => (
                  <span class="rounded-full bg-secondary px-3 py-1 text-sm font-medium">
                    {genre.name}
                  </span>
                ))}
              </div>
            )}

            {movie.overview && (
              <div class="space-y-2">
                <h2 class="text-xl font-semibold">Opis</h2>
                <p class="leading-relaxed text-muted-foreground">
                  {movie.overview}
                </p>
              </div>
            )}

            <!-- Action Buttons -->
            <div class="flex flex-wrap gap-3 pt-4">
              <MovieRating client:load tmdbId={Number(tmdb_id)} movieTitle={movie.title} />
              <Button variant="outline">Dodaj do listy</Button>
            </div>
          </div>

          <!-- Back Button at bottom -->
          <div class="pt-4 border-t border-border">
            <Button variant="outline" size="sm" asChild>
              <a href="/" class="flex items-center gap-2">
                <ArrowLeft className="size-4" />
                <span>Powrót do strony głównej</span>
              </a>
            </Button>
          </div>
        </div>
      </div>
    </div>
  </div>
</Layout>
