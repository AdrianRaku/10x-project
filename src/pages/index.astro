---
import Layout from "../layouts/Layout.astro";
import { MainView } from "../components/MainView";

export const prerender = false;

// Get authenticated user from middleware
const user = Astro.locals.user;

if (!user) {
  return Astro.redirect("/login");
}

// Fetch user's ratings count from database
const { data: ratings, error } = await Astro.locals.supabase.from("ratings").select("tmdb_id").eq("user_id", user.id);

if (error) {
  throw new Error(`Failed to fetch user ratings: ${error.message}`);
}

const ratingsCount = ratings?.length ?? 0;

// Configuration
const RATINGS_THRESHOLD = 10;
const RECOMMENDATIONS_DAILY_LIMIT = 5;
const username = user.email;
---

<Layout title="MyFilms - Strona główna">
  <MainView
    client:load
    username={username}
    ratingsCount={ratingsCount}
    ratingsThreshold={RATINGS_THRESHOLD}
    recommendationsLimit={RECOMMENDATIONS_DAILY_LIMIT}
  />
</Layout>
